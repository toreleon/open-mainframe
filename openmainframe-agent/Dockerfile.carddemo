# =============================================================================
# OpenMainframe CardDemo Docker Image
# Multi-stage build: Rust compiler → Python runtime with bridge daemon
# =============================================================================

# ---------------------------------------------------------------------------
# Stage 1 — Build the open-mainframe Rust binary (no LLVM, default features)
# ---------------------------------------------------------------------------
FROM rust:1.82-slim-bookworm AS builder

RUN apt-get update && apt-get install -y --no-install-recommends \
        pkg-config libssl-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# Copy workspace manifests first for better layer caching
COPY Cargo.toml Cargo.lock ./
COPY crates/ crates/

# Build only the CLI binary with default features (no LLVM / inkwell)
RUN cargo build --release -p open-mainframe

# ---------------------------------------------------------------------------
# Stage 2 — Lightweight Python runtime with CardDemo + bridge
# ---------------------------------------------------------------------------
FROM python:3.12-slim-bookworm

RUN apt-get update && apt-get install -y --no-install-recommends \
        libssl3 \
    && rm -rf /var/lib/apt/lists/*

# Install Python deps for the bridge daemon
RUN pip install --no-cache-dir websockets

# Copy the compiled CLI binary
COPY --from=builder /build/target/release/open-mainframe /usr/local/bin/open-mainframe

# Lay out the workspace so prepare-data.sh's relative paths work unchanged:
#   /workspace/aws-mainframe-modernization-carddemo/  ← CardDemo source
#   /workspace/carddemo-config/                       ← config & data prep
WORKDIR /workspace

COPY aws-mainframe-modernization-carddemo/ aws-mainframe-modernization-carddemo/
COPY carddemo-config/ carddemo-config/

# Prepare VSAM data files at build time (fast container startup)
RUN chmod +x carddemo-config/prepare-data.sh \
    && cd carddemo-config && bash prepare-data.sh

# Copy bridge scripts
COPY openmainframe-agent/bridge/ /bridge/

# Copy entrypoint
COPY openmainframe-agent/deploy/bridge-entrypoint.sh /usr/local/bin/bridge-entrypoint.sh
RUN chmod +x /usr/local/bin/bridge-entrypoint.sh

ENV BRIDGE_SERVER_URL=ws://host.docker.internal:8123/ws/bridge
ENV PYTHONUNBUFFERED=1

ENTRYPOINT ["bridge-entrypoint.sh"]
